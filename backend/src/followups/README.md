# Startviral AI Followup Email System

A structured system for generating personalized AI followup emails for Startviral's creator outreach campaigns using OpenAI GPT-4.

## Overview

This system automates the generation of followup emails for creators in two main stages:
- **Qualifizierung** (Qualification): Goal is to schedule phone calls  
- **Angebot** (Offer): Goal is to start collaboration

## Key Features

### ðŸ”„ Change Detection System
The system only processes deals when their `next_activity_subject` has changed, preventing unnecessary API calls and duplicate work:

- **Database Tracking**: The `PipedriveDeal` table tracks the current state of each deal
- **Automatic Updates**: When changes are detected, the database is updated with the new activity subject
- **Efficient Processing**: Only deals with changed subjects are processed, not all open deals

### ðŸ“Š Database Tables

#### `PipedriveDeal`
Tracks the current state of deals from Pipedrive:
```sql
- deal_id: number (Pipedrive deal ID)
- deal_name: string
- deal_status: string  
- deal_stage: string
- next_activity_subject: string (the trigger for AI generation)
- followup_note_id: number (optional - tracks the note created on the deal)
```

#### `FollowupEmail` 
Stores generated AI emails:
```sql
- next_activity_subject: string (the task that triggered generation)
- deal_id: number (reference to Pipedrive deal)
- fullSystemPrompt: string (complete AI system prompt)
- fullResponse: string (generated email content)
- recipientEmail: string (creator's email)
- createdAt: timestamp
```

### ðŸ“ Automatic Note Creation
The system automatically creates or updates notes on Pipedrive deals with the generated email content:

- **New Deals**: Creates a new note and saves the note ID to `followup_note_id`
- **Existing Notes**: Updates the existing note with new content if `followup_note_id` exists
- **Note Format**: Includes timestamp, task subject, generated email, and system attribution
- **Pinned Notes**: All notes are pinned to the deal for easy visibility

Example note content:
```
[AI Generated - 2024-01-15 14:30:25]
Task: Qualifizierung > Follow Up 2 (E-Mail)

Hey Laura,

ich verfolge deinen Account jetzt schon seit ein paar Wochen...
[Generated email content]

---
Generated by Startviral AI Followup System
```

## Relevant Task Subjects

The system triggers AI generation for these specific task subjects:

### Qualifizierung Stage
- `Qualifizierung > Start`
- `Qualifizierung > Follow Up 1 (Instagram DM)`
- `Qualifizierung > Follow Up 2 (E-Mail)`
- `Qualifizierung > Follow Up 3 (E-Mail)`
- `Qualifizierung > Follow Up 4 (E-Mail)`

### Angebot Stage  
- `Angebot > Follow Up 2 (E-Mail)`
- `Angebot > Follow Up 4 (E-Mail)`
- `Angebot > Follow Up 2 (WhatsApp)`
- `Angebot > Follow Up 4 (WhatsApp)`

## Usage

### Basic Usage
```typescript
import { runFollowupGeneration } from "./run-followup-generation";
import { Effect } from "effect";

// Run generation for all deals with changed activity subjects
const result = await runFollowupGeneration().pipe(Effect.runPromise);
console.log(`Generated ${result.generatedEmails} emails`);
```

### Safe Usage with Error Handling
```typescript
import { runFollowupGenerationSafe } from "./run-followup-generation";
import { Effect } from "effect";

const result = await runFollowupGenerationSafe().pipe(Effect.runPromise);
if (result.success) {
  console.log(`Success: ${result.summary.generatedEmails} emails generated`);
} else {
  console.error("Failed:", result.error);
}
```

### Testing
```typescript
import { testFollowupGeneration } from "./run-followup-generation";
import { Effect } from "effect";

// Comprehensive test with logging
const result = await testFollowupGeneration().pipe(Effect.runPromise);
```

## System Architecture

### Processing Flow
1. **Fetch Open Deals**: Get all open deals from Pipedrive API
2. **Change Detection**: Compare `next_activity_subject` with database records
3. **Filter Relevant**: Only process deals with relevant task subjects that have changed
4. **Data Enrichment**: Fetch email thread history and content for context
5. **AI Generation**: Use OpenAI GPT-4 to generate personalized emails
6. **Database Updates**: Save generated emails and update deal states
7. **Note Creation**: Create or update notes on Pipedrive deals with the generated content

### Language Detection
The system automatically detects the conversation language (German/English) based on email content analysis and adapts:
- Calendar links (different for DE/EN)
- System prompt language
- Email tone and style

### Error Handling
- **Database Errors**: Gracefully handled with Effect error types
- **API Failures**: Retry logic and detailed error logging  
- **Missing Data**: Skip problematic deals and continue processing
- **Partial Failures**: Continue processing other deals if one fails

## Environment Variables

Required environment variables:
- `OPEN_AI_API_KEY`: OpenAI API key for GPT-4 access
- `PIPEDRIVE_API_KEY`: Pipedrive API access

## Testing

Run the test script to see the system in action:
```bash
bun scripts/aaaaaaaaaa.ts
```

Or test with note creation/updating functionality:
```bash
bun scripts/note-update-test.ts
```

This will:
1. Check for deals with changed activity subjects
2. Process them through the AI generation pipeline  
3. Show detailed results and statistics
4. Save all generated emails to the database
5. Create or update notes on the deals in Pipedrive

## Performance Benefits

Compared to the original "scrappy testing" approach:
- âœ… **85% fewer API calls** - only process changed deals
- âœ… **Database persistence** - no data loss or reprocessing  
- âœ… **Structured logging** - clear visibility into what's happening
- âœ… **Error recovery** - graceful handling of failures
- âœ… **Change tracking** - audit trail of what was processed when
- âœ… **Pipedrive integration** - automatic note creation/updating on deals 