import { BunRuntime } from "@effect/platform-bun";
import { db } from "backend/src/db";
import { pipedriveLIVE } from "backend/src/pipedrive";
import { DealPipedrive } from "backend/src/pipedrive/objects/deal";
import { stripe } from "backend/src/stripe";
import { chunkArray } from "backend/src/utils/chunkArray";
import { sendSlackMessageE } from "backend/src/utils/slack";
import { Console, Effect, Schedule, pipe } from "effect";
import { sql } from "kysely";
import {
	GmailClient,
	GoogleAuthClient,
	GoogleAuthTokenStore,
} from "../auth/services";
import { blacklistEmails } from "../emails/blacklist";
import { bulkAddFilters } from "./filters";

const notInAnyFilters = (emails: string[], targetEmail: string) =>
	pipe(
		Effect.all(
			chunkArray(emails).flatMap((chunk) =>
				pipe(
					Effect.tryPromise(() =>
						db
							.selectFrom("GmailForwardingRules")
							.select("GmailForwardingRules.sentFrom")
							.where("sentFrom", "in", chunk)
							.where("sentTo", "=", targetEmail)
							.execute()
							.then((l) => l.map((x) => x.sentFrom)),
					),
					Effect.map((inDB) => chunk.filter((x) => !inDB.includes(x))),
				),
			),
			{ concurrency: 3 },
		),
		Effect.map((x) => x.flat()),
	);

const pipedriveCustomerEmails = pipe(
	Effect.all([DealPipedrive.getAllWon(), DealPipedrive.getTestphaseDeals()], {
		concurrency: "unbounded",
	}),
	Effect.scoped,
	Effect.map(([wonDeals, testphaseDeals]) => [...wonDeals, ...testphaseDeals]),
	Effect.map((deals) =>
		deals.flatMap((deal) => deal.person_id?.email.map((e) => e.value) || []),
	),
	Effect.map((emails) => emails.filter((e) => e !== "")),
	Effect.tap((x) =>
		console.log("total pipedrive count (won + testphase):", x.length),
	),
	Effect.provide(pipedriveLIVE),
);

const stripeCustomerEmails = pipe(
	stripe.getAllCustomers,
	Effect.map((customers) => customers.map((c) => c.email ?? "")),
	Effect.map((customers) => customers.filter((c) => c !== "")),
	Effect.tap((x) => console.log("total stripe count:", x.length)),
);

// Client's additional email list (emails not in Pipedrive)
const clientEmailList: string[] = [
	"alina.rudya@gmail.com",
	"mauwayblog@gmail.com",
	"eee.penky@googlemail.com",
	"viktorytimeforyou@gmail.com",
	"info@azsports.de",
	"michaelzusolms@gmail.com",
	"denise.schmelzer@t-online.de",
	"julia.breuing@web.de",
	"Jamesmoony@yahoo.de",
	"danielgoihl@googlemail.com",
	"mail@kkkeiki.com",
	"riccardo.lex@achievie.com",
	"info@reachhunter.de",
	"esther.fischer@gmx.ch",
	"d.lippemeier@gmx.de",
	"sb@insideall-agentur.de",
	"marvin.koerner90@gmail.com",
	"12curlywurly@gmail.com",
	"klaudigb@web.de",
	"petra.schott@gmx.net",
	"nick@positivpower.com",
	"office@meatisst-consulting.com",
	"b.noehr@freshion-design.com",
	"marieyouoninstagram@googlemail.com",
	"belalim_20_@hotmail.de",
	"kontakt@lifeitself.de",
	"haeuschenliebe@web.de",
	"info@tobiwagner.com",
	"juliahfotografie@gmx.de",
	"coachjini@gmx.de",
	"me0@gmx.de",
	"jannis@djolde.com",
	"s.Doumbia@gmx.net",
	"allas_lifestyle@gmx.de",
	"natalie@lanaturel.de",
	"trunk.nadja@t-online.de",
	"hello@alexjeanne.de",
	"iweta@santamo.de",
	"info@unterholzt.de",
	"grimm-jessica@gmx.de",
	"info@mamaskiste.de",
	"hello@luisaharisch.com",
	"lambert81@gmx.de",
	"conny@conny-doll-lifestyle.de",
	"hello@yvimr.de",
	"laleleben@gmail.com",
	"management@patriciagrimm.de",
	"Louwenrezepteblog@hotmail.com",
	"familiehochsechs@web.de",
	"bellatheglobetrotter@gmail.com",
	"styleisageless@web.de",
	"martinaent@food-stories.at",
	"nora.maite.instagram@gmail.com",
	"aboutpatricia@outlook.com",
	"verena@mamawahnsinn.com",
	"97shreyag@gmail.com",
	"hello@thatfuelforlife.com",
	"info@leagoetz.com",
	"melissawxc@yahoo.com",
	"ek@ich-verstehe-es.com",
	"julia-matthes@t-online.de",
	"ina_d@gmx.at",
	"info@verwaltung-service.de",
	"patrick.fl@arcor.de",
	"info@simply-vegan.org",
	"olala2011@gmx.de",
	"marie@entourage-communications.com",
	"mail@kateandthegirls.com",
	"tobias.paul@urbanerie.de",
	"lotteweissbach@aol.com",
	"sero.demir@gmx.ch",
	"Martina.stasch@stasch24.de",
	"nadja@travelprincess.de",
	"g.eorgii_@outlook.com",
	"isabellajahn_@outlook.com",
	"melanie.savic@gmx.net",
	"jaanagoeslightly@yahoo.de",
	"info@lourenegoll.de",
	"hello.its.me.anni@web.de",
	"verenadohmen@icloud.com",
	"clarissa@vogueupcall.com",
	"info@silvia-rausch.de",
	"info@torsten-kleint.com",
	"erikscholzcontact@gmail.com",
	"contact@beautxx.de",
	"tara.louise.wagner@googlemail.com",
	"alvaro.vahdat@gmail.com",
	"kontakt@cookieundco.de",
	"jenny.noemi@gmx.at",
	"anna@orzelski.de",
	"bellazinfromtheblock@gmail.com",
	"hello@marcobaeni.ch",
	"info@kettlebell-rebel.com",
	"info@anastasiabauer.com",
	"katharinakandel@gmx.de",
	"info@perelmusic.com",
	"isak.sunday.o@icloud.com",
	"info@karolovesmilka.de",
	"toni.zimmermann@gmx.net",
	"tanja@innerwisdom.de",
	"louwenrezepteblog@hotmail.com",
	"hebammemaren@gmx.com",
	"cs@chris-schild.com",
	"corinna.kamper@gmail.com",
	"info@martinafaron.com",
	"wolfspfoetchen@awolfylife.de",
	"info@sonja-schwarz.com",
	"anastasia@tendancehunter.com",
	"rausch.raphaela@hotmail.de",
	"info@meisezwillinge.de",
	"mariliaserpa98@gmail.com",
	"cornelia@family-vibes.com",
	"elkeschall@gmx.de",
	"thisisivyg@gmail.com",
	"vida.conte@web.de",
	"info@kiligdress.de",
	"denise@whileshewanders.com",
	"discovered.contact@gmail.com",
	"bjoern@bergparadiese.de",
	"balina2207@gmx.de",
	"nilocampisi@gmail.com",
	"Mara.ka.8484@gmail.com",
	"blitzwinkel.alexander@gmail.com",
	"wenndudabist@outlook.com",
	"dk@goetzinger-komplizen.de",
	"gang.dennis@yahoo.de",
	"info@astridstoeppel.com",
	"iamferhatofficial@gmail.com",
	"sushis.welt@outlook.com",
	"ostrotmann@aol.de",
	"info@mark-reeve.com",
	"info@svenhebbinghaus.de",
	"info@saskia-leppin.de",
	"pbrun85@gmail.com",
	"nora.henes@icloud.com",
	"martinkettenmeyeer@gmail.com",
	"foodschau@web.de",
	"andreas.hinzer@web.de",
	"beluisa2017@gmail.com",
	"info@misha-online.com",
	"diabeteswelt@web.de",
	"mail@janinajung.de",
	"grace@montanasocials.com",
	"jessica_ro@web.de",
	"ugc-danyila@web.de",
	"ninigurchihome@gmail.com",
	"info@ninameise.de",
	"schoenfuss@black.com",
	"kontakt@elif-canbulat.com",
	"peterwittkamp@gmx.de",
	"baklava@ayseskochblog.de",
	"heikewvn@me.com",
	"deguzmanvollgaaas@gmail.com",
	"jd@praterdome.at",
	"office.katharina@icloud.com",
	"cocon18@icloud.com",
	"info@graeveltravel.com",
	"ivonnepiekut@gmail.com",
	"amoviaggio@outlook.com",
	"chantalbunga@hotmail.com",
	"post@working-labrador.de",
	"buchhaltung@juwelier-sandkuehler.de",
	"isntitcosy@gmail.com",
	"kathy@koerperliebe.net",
	"dani-ramos100@hotmail.com",
	"athi@sailygroup.com",
	"info@makeupbyec.com",
	"dani.cronauer93@gmail.com",
	"ojuuunmichael@gmail.com",
	"contact@npj-designs.com",
	"mail@janheinemann.com",
	"ks@kaisteppan.de",
	"contact@onurkolev.de",
	"cihat-akipa@mail.de",
	"bio@frischetrend.com",
	"theresa.oesterreich@googlemail.com",
	"raphaela.gromes@yahoo.de",
	"mastro1000@web.de",
	"majahieke@t-online.de",
	"ds@dino-schaefer.de",
	"blum.michael82@gmail.com",
	"contact@yaelanders.com",
	"christoph.koechy@amilla-marketing.com",
	"abwolter@t-online.de",
	"hyla-wentzlau@gmx.de",
	"info@luisa-stepper.de",
	"riemer.vanessa@hotmail.com",
	"hallo@trost-tiger.de",
	"alica.artworks@web.de",
	"bernabahia.haddad@gmail.com",
	"klaas@klaas-music.de",
	"sarah@zueriplausch.ch",
	"princessfromoremountains@zohomail.eu",
	"dievanboys@mail.de",
	"akos.rebenyi@gmx.de",
	"hany115@web.de",
	"tr@torstenruether.de",
	"office@gesundmitplan.de",
	"caro@augenweide-graz.at",
	"arnd@drumcomplex.de",
	"christina.kurzer@beautyprime.de",
	"mail@deinbauchgefuehl-nb.de",
	"info@hamid-limo.de",
	"marie-sophie.vetter@web.de",
	"redsamrap@gmail.com",
	"kooperation@sophia-kuelper.de",
	"bressel.home@web.de",
	"cornelia.matt@bluewin.ch",
	"maikehuster3@web.de",
	"info@lindafaeh.ch",
	"robinsinger.fitness@gmail.com",
	"valeryymrg@yahoo.com",
	"Nell.Elbers@web.de",
	"marina.fonf@gmail.com",
	"dialog@drvolkerbusch.de",
	"ph.aschi@gmail.com",
	"info@sebastianbronk.com",
	"anni.meisner@gmx.de",
	"info@bassamthebutcher.de",
	"alexandra@dirndlontour.com",
	"doerfler@gg-gewerkschaft.de",
	"iam@nataliebruene.com",
	"denny.pham@hotmail.de",
	"info@uli-fischer.net",
	"info@friseur-kuhs.de",
	"granit.stein@granit-stein.com",
	"tadej.jaki@yahoo.de",
	"info@inkformal-tattoo.com",
	"juliamarie.jk@gmail.com",
	"socialmedia@bibi-bilanzierung.de",
	"majidmoth1@gmail.com",
	"rizzutiorlando@yahoo.de",
	"marekhuesemann@web.de",
	"howlifecouldbe.sam@gmail.com",
	"hallo@johannadebes.life",
	"katjas@gmx.de",
	"marcel.brandt@yahoo.de",
	"shakira33@web.de",
	"jil@avelynaofficial.com",
	"nico.reuter@ecoparc-concepts.de",
	"ni.blattmann@gmx.ch",
	"lukasjonas987@gmail.com",
	"lisa.ederer@gmx.com",
	"info@sergen-isici.com",
	"slemcut@gmail.com",
	"sara.glawe@yahoo.de",
	"patricia_franke@yahoo.com",
	"info@golden-signals.com",
	"the@travelrenaissanceman.com",
	"mail@olafhajek.com",
	"info@lucastiefenthaler.com",
	"filipsrb1510@proton.me",
	"lknehs@gmail.com",
	"wideawakearthquake@gmail.com",
	"fritz@fritzante.eu",
	"mgmt.jamin@gmail.com",
	"steffen.wagner.bln@gmail.com",
	"ronja@lybstes.de",
	"info@abel-realestate.com",
	"philipschaeffer98@icloud.com",
	"vanessamariaviktoria@yahoo.com",
	"th@thorsten-havener.com",
	"service@sophiekunterbunt.de",
	"johannavolz@yahoo.de",
	"densenmensen@gmx.de",
	"sarahbaukau@gmx.de",
	"info@trend-agent.at",
	"kontakt@tina-reichel.com",
	"cjstephiperformance@gmail.com",
	"agnes.rode@gmx.de",
	"office@kristinalunz.com",
	"youcefs2121@gmail.com",
	"info@stylealbum.com",
	"nina@livingholistic.today",
	"post@matthias-esch.de",
	"lionesslenita@gmail.com",
	"mail@marcohirsiger.ch",
	"renzo@cicillini.ch",
	"metz@metzilla.ch",
	"info@sue-dhaibi.com",
	"post@wienerwuzzi.at",
	"buero@katiasaalfrank.de",
	"nh@nicohensel.de",
	"ellipascal@gmail.com",
	"bryanskoppen@hotmail.com",
	"ferreirapais@icloud.com",
	"photo@philbucher.com",
	"aija@alsinamusic.com",
	"joana-michalski@web.de",
	"alexandra.gorsche@genusspunkt.at",
	"salliespring1@gmail.com",
	"studio@callekocht.com",
	"danbuser@mac.com",
	"info@andreasortner.com",
	"marion.moerth.top@gmail.com",
	"nikisbeautychannel@yahoo.de",
	"dersozialarbeiter1@gmail.com",
	"asobenhaus@icloud.com",
	"info@fabianfarell.com",
	"hello@nopanic.coffee",
	"info@derdieseiner.ch",
	"info@mm-uhrenatelier.de",
	"instagram@rene-visual-arts.com",
	"cj.sentman@gmail.com",
	"shultsmarianna@icloud.com",
	"inga@strangmeyer.com",
	"info@nicorein.de",
	"andrea.schott@me.com",
	"thorsten@thekitchenhero.de",
	"william.hage1@gmail.com",
	"kontakt@fashion-kitchen.com",
	"buchhaltung@brocke-group.de",
	"mail@svengelhaus.de",
	"adel.el-assaad@hotmail.de",
	"maikeschmidt96@gmail.com",
	"info@immobilien-lindstedt.de",
	"info@robert-bohnke.com",
	"orphey.philipp@googlemail.com",
	"monika.kovatsch@gmail.com",
	"mara.g@gmx.eu",
	"elarexhaa@gmail.com",
	"jenny.kaltenhauser@icloud.com",
	"info@michaelkrogmann.de",
	"Samira.Bou1986@gmx.de",
	"araceliacostamakeupartist@gmail.com",
	"moin@elbgoods.de",
	"brigittemoisa@yahoo.de",
	"mekoudja@yahoo.fr",
	"office@lukassteiner.at",
	"marija.paganini@gmail.com",
	"andre.sarholz@ktm-sarholz.de",
	"hinnerk.baumgarten@online.de",
	"katharina.nagele@gmx.at",
	"daniela@nenalisi.de",
	"yeisenel@gmail.com",
	"j.laubenthal@gmx.net",
	"inusa@inusagroove.com",
	"info@marcmosca.com",
	"patrick.psiuk@gmail.com",
	"seilerarta@gmail.com",
	"kathleen-richter@hotmail.com",
	"dermamo_official@web.de",
	"kontakt@gordon-bieling.de",
	"redaktionHug@t-online.de",
	"hello@gulsahkaraca.com",
	"billy-jean.tattoo@gmx.de",
	"viktoria.halenarova@gmail.com",
	"katalina.koss@gmail.com",
	"uta-maier@gmx.de",
	"klaraschafir@gmail.com",
	"info@ds-automotive.eu",
	"markus@be-musica.com",
	"manuleo@gmx.ch",
	"thelionheaded@gmail.com",
	"info@roland-auer.com",
	"mariona.grasell@gmx.de",
	"kunst@sabinebeisert.de",
	"jo@jo-kern.com",
	"info@roman-rohrmoser.com",
	"hallo@frau-winter.de",
	"info@simonstraetker.com",
	"samirabeaute@outlook.de",
	"ritualblackworkcvlt@gmail.com",
	"simply.martina@web.de",
	"office@vickylash.com",
	"contact@artbywenzo.com",
	"info@sturbock.me",
	"nprieger@mandala-fashion.com",
	"danyhase@gmx.at",
	"ssieberer@gmx.at",
	"victoria.eisterer@averie.at",
	"marenleerhoff@googlemail.com",
	"hallo@marionaspalter.at",
	"boggy214@icloud.com",
	"fant@gmx.ch",
	"info@vita4good.com",
	"violetta.buggel@gmail.com",
	"roman@terracollage.com",
	"kjasperneite@gmx.net",
	"juliebarzman@yahoo.com",
	"bg@bennigrams.de",
	"jane.uhlig@janeuhlig.de",
	"info@gratitudeverlag.de",
	"sarah@itchyfeet-travel.de",
	"finance@heytwinny.com",
	"glamupyourlifestyle@t-online.de",
	"juliajul.82@icloud.com",
	"manuel.simon@dvag.de",
	"marija.kosutic@icloud.com",
	"steffi@heypretty.ch",
	"info@hangliebe.de",
	"jenny.engler@web.de",
	"jo.jada@gmx.de",
	"kontakt@chanle.de",
	"freelancer@kiriakakis.com",
	"ally.queen.music@gmail.com",
	"junkimart@yahoo.de",
	"info@dianadari.com",
	"info@thechicadvocate.com",
	"Daniel@hamannstattoostudio.dk",
	"einfach.emilou@hotmail.com",
	"pizzaboymax@gmail.com",
	"fuchs.martina@gmail.com",
	"rosiagi117@gmail.com",
	"info@fressmoppel.de",
	"hello@typed.de",
	"kooperationen@alwayslikeafeather.de",
	"doro181274@gmail.com",
	"missjulia.collabs@gmail.com",
	"art@alexhuelbach.com",
	"benjamin.maerz@hotel-rose.de",
	"susanne.ackstaller@textelle.de",
	"maria.wilhelm@cocibus.com",
	"oostveen@gmx.de",
	"sabine_klinger@gmx.net",
	"info@katjademming.com",
	"tabea_willemsen@yahoo.com",
	"daniela.lamprecht@hotmail.com",
	"shop@charis-chi.de",
	"info@annamaier.art",
	"bilalahmad.777@yahoo.com",
	"peter.schaeublin@me.com",
	"info.cobelicious@gmail.com",
	"cri.zz.tina@icloud.com",
	"michaelparamonti@gmail.com",
	"kooperationen@the-kaisers.de",
	"n.vodicka@gmail.com",
	"info@10amstudio.de",
	"email.markus.lehr@googlemail.com",
	"info@daniel-korte.com",
	"sabrina.schreiner1@gmx.at",
	"kontakt@avaloustudios.de",
	"michaela.suessbauer@web.de",
	"masterofchocolate@gmail.com",
	"charles-m@gmx.net",
	"xavier.turpain@abalir.ch",
	"office@goricajeremic.com",
	"info@tyronricketts.com",
	"jjdinterior@jojada24.de",
	"julia@xray-music.com",
	"ronjaanddeniz@gmail.com",
	"da.silva.tanja@gmail.com",
	"norma@quinto.com",
	"steph.jaksch@me.com",
	"hendrik.gottschalk@me.com",
	"pfotentraumzubehoer@gmx.com",
	"info@tektherapy.eu",
	"peter@peterzimmermann.com",
	"marketing@linriehl-brautmode.de",
	"robert.klie@web.de",
	"britta@hamburg-mode.com",
	"studioelenabulycheva@gmail.com",
	"elif@serifoglou.de",
	"mirco.michel@outlook.com",
	"office@coupleofvision.de",
	"reasawatzki@hotmail.de",
	"bzeka@live.at",
	"camillhauser@gmail.com",
	"mikail_98@live.de",
	"c.ehrlich@docma-tv.com",
	"amelie.satzger@gmail.com",
	"daniuhrich@gmail.com",
	"jetamekolli@gmail.com",
	"andy@vw-racing.org",
	"mone.buengert@gmail.com",
	"muriel@momof4.ch",
	"office@style-and-bloom.de",
	"jasmin@fraueckertmeckert.de",
	"post@ourtravelness.com",
	"info@julianpfoertner.com",
	"pb@h-m-a.com",
	"kontakt@diana-schell.com",
	"jenny@mybodytoning.com",
	"janipaulo19@gmail.com",
	"spitzenberger@die-spitzenmakler.de",
	"burakmunar@gmail.com",
	"manuelasamat@gmail.com",
	"booking.zoodiak@gmail.com",
	"steffenhunsen@googlemail.com",
	"info@starpromotion.net",
	"denise_mojen@hotmail.de",
	"timo.szopieray@web.de",
	"kroboth@biorausch.com",
	"info@djmartinleiste.de",
	"diepersyannik@gmail.com",
	"christian@biesels.de",
	"stefan@hessler-motorsport.de",
	"d.schick@schick-media.de",
	"ra-larverseder@mail.de",
	"leilab.666business@gmail.com",
	"david.unterleitner@gmail.com",
	"genny@gennyfromtheblog.com",
	"kevinlukarski@gmail.com",
	"r.lleshaj@gmx.ch",
	"finance@byb-agency.com",
	"hello@mayhomestyle.com",
	"edenbeatzinc@gmail.com",
	"management@martinkto.com",
	"alwaysnein@posteo.de",
	"mail@nadjazimmermann.ch",
	"info@yvonnegertig.de",
	"paul@firechefs.de",
	"dennis@stark-fussball.de",
	"s.assadi@smile-id.de",
	"Kontakt@alexprofant.de",
	"mail@nickmagic.world",
	"dennis@creuzberg.com",
	"offers@lomouri.com",
	"info@lena-kinderfragen.de",
	"info@meinkochuniversum.de",
	"info@butchvoyage.com",
	"info@allsenses.de",
	"ezenikie1er@yahoo.fr",
	"marion_reber@hotmail.com",
	"altbauliebe.hamburg@gmail.com",
	"contact@rob-georg-music.com",
	"marcus.sonntag@me.com",
	"management@patrickhonsal.com",
	"info@enzoescoba.de",
	"a.klbr@web.de",
	"angi@turns.de",
	"ralf@ralfschnell.me",
	"lauraschmidt90@yahoo.com",
	"sandra@sandrastaub.com",
	"home@markusothmer.de",
	"Bodyfitvital@gmail.com",
	"aakub98@yahoo.de",
	"benjamin@athletic-heroes.com",
	"dragica.schadegg@gmail.com",
	"info@halalmitkrawall.de",
	"tp.invest@aol.com",
	"claudia.danner@a1.net",
	"backoffice@klassenheld.de",
	"lacortetattooer@gmail.com",
	"info@missjule.de",
	"isa@larilara.de",
	"rechnung@amelia-immobilien.de",
	"alechhala13@gmail.com",
	"alinatamaraa@gmail.com",
	"m.kamps@permanent-event.de",
	"Info@chris-promotion-agency.com",
	"udo@rvndm.com",
	"stefanie.baum@email.de",
	"kontakt@silkevonclarmann.com",
	"kpschmidt2009@gmail.com",
	"info@mikekarg.com",
	"coaching@projectshape.de",
	"nigeldewind@gmail.com",
	"gaby.muller@gmx.de",
	"dw@x-forming.de",
	"nicole@dieminervas.ch",
	"info@in-shape-studio.com",
	"info@danielahutter.com",
	"info@arthurlewismusic.com",
	"designmuller@icloud.com",
	"annetta.negare@gmx.de",
	"masur.daniel@googlemail.com",
	"alexandra.gorsche+sub2@genusspunkt.at",
	"semra.celebi@gmail.com",
	"info@charlotteschueler.de",
	"melinaaaglk999@gmail.com",
	"hello@jaycnell.de",
	"salon.lagerpusch@web.de",
	"glimlip@gmail.com",
	"info@susanne-boerner.de",
	"Orxeljeff@gmail.com",
	"m.diaz@bauenundleben.com",
	"info@mint-pure.at",
	"info@andremiegel.de",
	"info@madeleinebryan.de",
	"presse@staab-pr.de",
	"djnapoli@bluewin.ch",
	"richard_p_laurent@hotmail.com",
	"chris_brueck@web.de",
	"ninas.interiordesign@gmx.de",
	"vivi.paetz@live.de",
	"info@rosabeauty.de",
	"andreadiste@gmx.de",
	"felix@jelix.de",
	"mizeb.marketing@gmx.de",
	"laviesposa@gmail.com",
	"jessica.ugc@web.de",
	"hi@lukasziegler.fitness",
	"contact@andra-photography.de",
	"johanna-witt@web.de",
	"nina.reisenegger@gmx.at",
	"sarah@mycottagegarden.de",
	"angela_jck@gmx.de",
	"thomas_vieth1995@yahoo.de",
	"annejohne@gmail.com",
	"info@jasmingretler.com",
	"nuhul.td@gmx.de",
	"hello@tugbakement.com",
	"guitarraphael@yahoo.com",
	"personal.coaching@antjesimdorn.com",
	"sacredheart@t-online.de",
	"moderation@carolin-henseler.com",
	"sonja-wickerath@web.de",
	"tropetsm@yahoo.de",
	"info@kanzlei-baumfalk.de",
	"office@diefotomanufaktur.at",
	"a.giesser99@gmail.com",
	"carinasimm@hotmail.com",
	"elianescwfr@gmail.com",
	"info@patrickloertscher.com",
	"hollygeddert@yahoo.de",
	"contact@travelpearls.ch",
	"olli.linda.business@gmail.com",
	"olaf.bernstein@backpackbaby.de",
	"info@elifgedik.com",
	"der@wald-stern.com",
	"pieroeugster@gmail.com",
	"c.eidloth@fertigdenker.de",
	"patrickthiele202@gmail.com",
	"tobiasyang4982@gmail.com",
	"joshua@embodiedsounds.com",
	"zahnarzt.achern@gmail.com",
	"lieblings_koch@web.de",
	"Isabella.Hiemer@gmail.com",
	"kyra.herzog@gmx.de",
	"hello@pureandrea.com",
	"amjadentertainment@gmail.com",
	"hoerbinger.eva@gmail.com",
	"caro@caros-babyzauber.de",
	"info@matthias-hoff.de",
	"theodoraflipper@yahoo.com",
	"diemelanie2.0@gmx.de",
	"nina_hopf@yahoo.de",
	"sandrakkad@gmx.de",
	"n.heitmar@freenet.de",
	"wolf.bogner@gmail.com",
	"mull555@icloud.com",
	"info@kickfiremusic.com",
	"lenaschoeninger@gmail.com",
	"juliagoldstern@gmail.com",
	"zazou.mentoring@gmail.com",
	"ron@stahlfux.com",
	"teresa-meyer@web.de",
	"info@elishka.de",
	"collab@iamcellina.de",
	"ms@epoxytable.it",
	"duy.eats.food@gmail.com",
	"danielreicheld@gmail.com",
	"holger@body-coaches.de",
	"info@claramorgenthau.de",
	"info@amanda-nails.ch",
	"ricky221562@gmail.com",
	"hello@beatriceannette.com",
	"aidshaabani@hotmail.com",
	"davo-art@t-online.de",
	"info@biorausch.com",
	"majarichter_dance@aol.com",
	"majarichter8@aol.com",
	"annemarie@skunkworx-design.de",
	"maksimklasanovic3@gmail.com",
	"bsniperboxing@web.de",
	"jessicatoepfer@icloud.com",
	"office@meetbirgituntermair.com",
	"umutparmak@icloud.com",
	"marius.hammel87@gmail.com",
	"paulina.kemnitz@icloud.com",
	"HypnoticTattooJen@gmail.com",
	"geoffrey.m@jurassicfruit.com",
	"dominikmayr.info@gmail.com",
	"info@flasheye.de",
	"ai@kenna-collectiv.com",
	"info@albertleichtfried.at",
	"m.mayer@hello-performance.com",
	"workwith.trustyourstyle@googlemail.com",
	"magdas_life89@yahoo.com",
	"cm@bertslide.com",
	"Kwabenao@web.de",
	"chrissy.mm@yahoo.com",
	"asya.fateyeva@gmail.com",
	"j.gontovos@icloud.com",
	"daniela.testet@web.de",
	"marina.hackspacher@web.de",
	"marcelfeber95@gmail.com",
	"soebine-blog@gmx.de",
	"mail@digitalvibes.at",
	"annkathrin_b@gmx.de",
	"m.buehler@ancoramoda.de",
	"nicole.stumpe@web.de",
	"contact@caterinacatalano.com",
	"ayse.manteuffel@yahoo.com",
	"babs@barbaralicious.com",
	"steven.jacobs1987@yahoo.de",
	"fabian.feber1995@gmail.com",
	"fiqfeli@gmail.com",
	"fischae@web.de",
	"marco.rutsch@allianz.de",
	"linda@lindarella.de",
	"tomislavras@gmail.com",
	"jenniferbredow@googlemail.com",
	"baerbel90@gmx.de",
	"nanaaj007@gmail.com",
	"kylestefanski9@gmail.com",
	"chrisfraas@outlook.de",
	"startviral.testing.dummy@fake.com",
	"jamesmoony@yahoo.de",
	"izubiks@yahoo.de",
	"muddirobbtdat@hotmail.com",
	"contact@fabzerzuben.com",
	"martinweiss84@outlook.com",
	"info@toluli.de",
	"family.loft98@gmx.de",
	"talktoelinabambina@gmail.com",
	"petersenpetra3@t-online.de",
	"aoes@gmx.ch",
	"roman.schmid@gmx.net",
	"guelenis@gmail.com",
	"contact@tobi-vogel.com",
	"info@mehralsgruenzeug.com",
	"happy4family@gmx.net",
	"kontakt@jankunath.com",
	"yasmin.shafi@web.de",
	"bennebenzing@web.de",
	"chaptersaboutisy@outlook.de",
	"startviral.unit.testing.13@fake.com",
	"zoe_adu_simpson@yahoo.com",
	"prettylikemommy3.0@gmail.com",
	"jessi_rehm@yahoo.de",
	"adamwendlermusic@gmail.com",
	"jeremi@the-enveloper.com",
	"andreas.muehlburger@hotmail.com",
	"keni73@web.de",
	"info@lucky-tattoo-pascal.de",
	"christopher@alpacacamping.de",
	"trendmum@gmail.com",
	"lydia_christina@outlook.com",
	"michi.angehrn@gmail.com",
	"model@timojulian.com",
	"marcelhutter@gmx.net",
	"kai@nuturn.de",
	"yourheartpix@posteo.de",
	"schwarz.annett.64@gmail.com",
	"philipp@housekasper.de",
	"martina_coric@gmx.de",
	"info@buruconstruction.nl",
	"abwolter@icloud.com",
	"feinstekleinigkeit@gmx.de",
	"hallo@nataliepinzauti.de",
	"nicola@wies-doch-geht.de",
	"claudia.schilling@me.com",
	"senada87@web.de",
	"stefan.joebstl@gmx.net",
	"tiger@kirchharz.de",
	"info@moedersheim.de",
	"leonie-lohkamp@t-online.de",
	"clarissabeckbusiness@gmail.com",
	"Sas@marcgalal.com",
	"ms@sperle-immobilien.de",
	"lydia.zoglmeier@gmx.at",
	"michelle.putame@hotmail.com",
	"businesssimplyjessy@gmx.de",
	"ca@cornelia-augustin.de",
	"marketing@rauhbank-woodart.de",
	"isajahn@outlook.de",
	"hello@ginmycoffee.com",
	"karamichailidisilias@icloud.com",
	"info@farbton-papier.de",
	"info@babor-sonjastaggl.at",
	"grundschulpassion@hotmail.com",
	"patrice.fritzsche@gmx.de",
	"kontakt@fabioplois.de",
	"sionattt@gmail.com",
	"info@kerstin-arnold.com",
	"emilkulikovek@gmail.com",
	"oesch.melanie@bluewin.ch",
	"louisa.noack@gmail.com",
	"daniel@handarbeit-tattoo.de",
	"happymomdiary@gmx.at",
	"simeon.kohlhepp11@gmail.com",
	"davoart@icloud.com",
	"iasonchronis@gmail.com",
	"hello@micawintermayr.com",
	"christianballhaus@gmail.com",
	"nora@hey-soho.com",
	"linas.beauty@hotmail.com",
	"domenico.ebner@googlemail.com",
	"riedl@dasraumgfuehl.at",
	"natalie@concept-management.eu",
	"ninemues@gmx.de",
	"astrid.hogl@kraeuter.wien",
	"diaz.seddux@gmail.com",
	"fynn.schuck@raykhahne.de",
	"constanze@constanzeguhr.de",
	"info@arricale.ch",
	"anna@gojowsky.de",
	"tattoo.urs.model@gmail.com",
	"info@justin-hahn.com",
	"kontakt@cosmetic-wissen.de",
	"claudiagelper14@gmail.com",
	"info@ahmet-yitik.de",
	"alexke.garcia@outlook.com",
	"chriscronauer.95@gmail.com",
	"info@ronaldhunter.com",
	"enquiries@mcllamas-curator.com",
	"aysesentuerk@icloud.com",
	"info@lisasalewski.com",
	"simonasgier@hotmail.com",
	"sandra@house-of-grace.de",
	"schmitz@ruhr-beef.de",
	"kohlalain@gmail.com",
	"annagamburg@posteo.de",
	"sofia.dbyty@gmail.com",
	"lisa_graf@outlook.com",
	"Patrick.Teutsch@web.de",
	"basic_kbk@web.de",
	"schelltv.info@web.de",
	"ingosagmal@yahoo.de",
	"christina.prosthetics@gmx.de",
	"simon.hostettler@gmx.ch",
	"florianludin@icloud.com",
	"fitar0n88@gmail.com",
	"julizsta@web.de",
	"partrick.tyborski@gmail.com",
	"enrico.dapote@gmail.com",
	"alberthaussler@aol.com",
	"jonasberthold2912@gmx.de",
	"dannywenzel78@gmail.com",
	"liesalucia89@web.de",
	"shah786_@outlook.de",
	"hengstmarkus3@gmail.com",
	"info@gainitreith.de",
	"viehmeyer.patrick@gmail.com",
	"Maximus.Schnabel@web.de",
	"ofcfelber@gmail.com",
	"kontakt@gafit.de",
	"info@pure-drink.com",
	"muskelpump@gmx.de",
	"berniozoria@hotmail.com",
	"ganijeva@me.com",
	"Denis-lennartz@web.de",
	"stbraun23@gmail.com",
	"domdugi01@outlook.de",
	"marvinberndt91@hotmail.com",
	"melissa.bondel@gmx.de",
	"micgue@gmx.net",
	"fahrettin.tatti@gmail.com",
	"eggert_vanessa@web.de",
	"artapice@yahoo.de",
	"live.store.de@gmail.com",
	"jean-marie@gmx.at",
	"sarah.s_adventures@gmx.de",
	"Tabea.H94@web.de",
	"office@djanrey.com",
	"probstreto@gmail.com",
	"Roman.Schmid@gmx.net",
	"zaisersteffen@googlemail.com",
	"alex.chatzis@web.de",
	"info@kevinbete.com",
	"bodenluca@web.de",
	"chris@wieneroriginalhaircraft.at",
	"yannis.karrer@yahoo.com",
	"philipp@bahntraining.de",
	"gerome_1996@hotmail.de",
	"Jasminaruns@web.de",
	"nicoeiselt@gmx.de",
	"marco.cali1997@gmail.com",
	"benedikt.friedrich@solutionsforweb.de",
	"gym_sam@gmx.de",
	"luisfrielingsdorf@outlook.de",
	"jona8613@gmail.com",
	"marco@taxfighter.de",
	"wiedemann.lara@web.de",
	"benel@gmx.de",
	"schufm@gmail.com",
	"joel.pena@hotmail.de",
	"andreaslieb1991@gmail.com",
	"info@stefanrieth.com",
	"wesleythompson@gmx.net",
	"louis.kortmann@gmx.de",
	"Jan.laukenmann@impuls2014.de",
	"joshua-menzer@gmx.ch",
	"benjamin.d.j.weisse@gmail.com",
	"basti-klein@t-online.de",
	"info@officialtimbo.com",
	"tim@esizebookings.de",
	"dasjannik@freenet.de",
	"stefan.dunkel90@gmail.com",
	"marc@byom.de",
	"edc59367@iencm.com",
	"bayer.maex@web.de",
	"josyblackx@gmail.com",
	"sarah-milka@web.de",
	"yookiebudia@gmail.com",
	"booking.fitnessmaus@gmx.de",
	"fasholyn@gmail.com",
	"i.guimaraes1407@gmail.com",
	"lifeoflone@gmx.de",
	"diieselly@gmail.com",
	"mhaeck50@gmail.com",
	"svetlana.wakounig@yahoo.com",
	"josephine.eggenstein@t-online.de",
	"andreasmanyet@gmx.at",
	"timo.jaekel@gmx.de",
	"laurawacker98@web.de",
	"mail@nilsrehm.com",
	"ras.otchere@web.de",
	"mirko.hoefflin@gmx.de",
	"kimvanessabraun@icloud.com",
	"klaus.riegler1@gmx.at",
	"Juliasw88@gmail.com",
	"juliesdresscode@gmail.com",
	"info.noahsarey@gmail.com",
	"tobiasdoerr16@gmail.com",
	"davidnegulyayev3@gmail.com",
	"tijna_fre@yahoo.com",
	"luis.kirchner1@icloud.com",
	"info@maximilian-gaedcke.com",
	"jules.mandel24@example.com",
];

// Log the client email list for debugging
const logClientEmails = pipe(
	Effect.succeed(clientEmailList),
	Effect.tap((emails) =>
		console.log("Client email list count:", emails.length),
	),
	Effect.tap((emails) => console.log("Client emails:", emails)),
);

const main = (target: string, customers: string[]) =>
	pipe(
		notInAnyFilters(customers, target),
		// Effect.succeed(customers),
		Effect.tap((emails) =>
			Effect.all(
				chunkArray(emails, 50).flatMap((chunk, i, arr) =>
					pipe(
						blacklistEmails(chunk),
						Effect.tap(
							Console.log(`[${i}/${arr.length}] done blacklisting chunk`),
						),
					),
				),
			),
		),
		Effect.tap((x) => Console.log(x.length)),
		Effect.andThen((emails) => bulkAddFilters(emails, target)),
	);

const program = pipe(
	GoogleAuthTokenStore,
	Effect.flatMap((store) =>
		Effect.all({
			accounts: store.getAll(),
			customers: pipe(
				Effect.all(
					[
						pipedriveCustomerEmails,
						stripeCustomerEmails,
						Effect.succeed(clientEmailList),
					],
					{
						concurrency: "unbounded",
					},
				),
				Effect.map((x) => Array.from(new Set(x.flat()))),
				Effect.tap((allEmails) => {
					console.log("\nðŸ“Š EMAIL SOURCES BREAKDOWN:");
					console.log(`ðŸ“§ Total combined emails: ${allEmails.length}`);
					// console.log(
					// 	`ðŸ” Pipedrive + Stripe + Client emails combined and deduplicated`,
					// );
				}),
			),
		}),
	),
	Effect.flatMap(({ accounts, customers }) =>
		Effect.forEach(
			accounts.filter(
				(account) =>
					account.email === "marc@startviral.de" ||
					account.email === "joleen@startviral.de",
			),
			(account) =>
				pipe(
					Console.log(`Saving filters for ${account.email}`),
					Effect.andThen(() => main(account.email, customers)),
					Effect.provide(GmailClient.Live(account.refreshToken)),
				),
		),
	),
	Effect.provide(GoogleAuthClient.Live),
	Effect.provide(GoogleAuthTokenStore.Live),
);

export const autoForwardingFilterCron = pipe(
	program,
	Effect.schedule(Schedule.cron("*/30 * * * *")),
	Effect.catchAllDefect((e) =>
		sendSlackMessageE(`defect in autoforwarding ${e}`),
	),
	Effect.catchAll(Console.error),
);

// BunRuntime.runMain(program.pipe(Effect.scoped));
